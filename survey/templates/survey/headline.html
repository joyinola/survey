<!DOCTYPE html>
<html>
    <head>
        <meta charset='utf-8'>
        <meta http-equiv='X-UA-Compatible' content='IE=edge'>
        <title>Headline</title>
        <link rel="icon" type="image/x-icon" href="static/images/favicon.ico">
        <meta name='viewport' content='width=device-width, initial-scale=1'>
        
        <script src="https://kit.fontawesome.com/3eb1cc4659.js" crossorigin="anonymous"></script>

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&display=swap');
        </style> 
        <link rel='stylesheet' type='text/css' media='screen' href='../../static/survey.css'>
    </head>  
    <body>
        <div id="expired_session" class="hidden alert "> Session expired. Please, refresh page</div>
        <!-- {%if info%}
        <div class=" alert alert-danger"> Session expired. Please, refresh page</div>
        {%endif%} -->
        <section id="headlinebody">
    <div class="container intro">
        <div id ='headlineRow' class="row">
            {%for i in p.object_list%}
            <div  class="col col-6 d-flex justify-content-center">
            <br>
            <div class="col-content">
                <br>
            <img name='headline', id='{{i.id}}' style="border-radius: 20px;" src="https://pollsng-bucket.s3.us-west-1.amazonaws.com/{{i.img}}"/>
        
            <br>
            <div class="vote_btn_div">
            <div class="upvote"> 
                <button data-id='{{i.id}}'  class='thumbs position-relative' data-thumbs="thumbs" data-page="{{p.number}}" id='tu{{i.id}}' 
                data-vote="upvote" name="vote"> <i class="fa-solid fa-arrow-up" ></i>
    
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-dark">
    
                    {{i.upvote}}
                    <span class="visually-hidden">unread messages</span>
                  </span>
                
                </button>
            </div>
            <div class="downvote">

                <button data-id='{{i.id}}' class='position-relative'data-thumbs="thumbs"  href="#" data-page="{{p.number}}" id="td{{i.id}}" 
                data-vote="downvote" name="vote"><i class="fa-solid fa-arrow-down" ></i>
    
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-dark">
                    {{i.downvote}}
                    <span class="visually-hidden">unread messages</span>
                  </span>
                
                </button>

            </div>
        </div>
          
         
          
         </div>
        </div>
            {%endfor%}
        </div>
        <br>
        <div id="taskuncomplete" class="hidden alert alert-danger">
            Please provide an upvote or downvote before proceeding
        </div>
        <br>
        <div class='votebtn btn_div'>
            {% if p.has_previous%}
            <button class="btnn  vote" id='previous' data-previous="{%url 'updateHeadline' p.previous_page_number%}"> < Previous</button>
            {%endif%}
            {%if p.has_next%}
        <div class="next_btn" >  <button class="btnn vote nextheadlines" data-href="{%url 'updateHeadline' p.next_page_number%}"> Next ></button>
        </div>
           
            {%else%}
            <div id="headline_next" style="display:inline-block">
            <button class="btnn" id="info"> Next Task ></button>
           </div>
            {%endif%}
        </div>
    </div>
 
   
            </section>
            <script src="../../../static/info.js"></script>
            <script type="text/javascript"> 
    if (document.getElementsByClassName('btn_div')[0].children.length===1){
        document.getElementsByClassName('btn_div')[0].style.justifyContent='end' 
    }
    try{
    const previous =document.getElementById('previous')
    previous.addEventListener('click',()=>{
    window.location=previous.dataset.previous})

}
catch{
   (e)=>{console.log(e)}
}
  

 

            const infoHeadline=[]
            const headline = document.getElementsByName('headline')
            for(i of headline){
                infoHeadline.push(i.id)
            }

            for (i of document.getElementsByClassName('nextheadlines')){
            const url=i.dataset.href
            
            i.addEventListener('click',(e)=>{
            // e.preventDefault()
            
            fetch(`/validatetask/`,
            {
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body:JSON.stringify(infoHeadline)}).then(
                response=>response.json()).then(data=>{
                    
                    if (data==="session_expired"){
                                
                document.getElementById('expired_session').classList.remove('hidden')
                document.getElementsByClassName('btn_div')[0].classList.add('hidden')
      
        window.onbeforeunload= ()=>{
        window.setTimeout(()=>{
            window.location='/'
        },0)
        window.onbeforeunload=null}
    }
    else{
                if(data==='false'){
                     document.getElementById('taskuncomplete').classList.remove('hidden')
                     
                }
                
                else{
        
            document.getElementById('taskuncomplete').classList.add('hidden')
            window.location=url}



                }}
            )
            
            

    
            })
            }
            window.onload=()=>{
                    fetch("/votecasted/",
                    {
                        method:"POST",
                        headers:{"Content-Type":"application/json"},
                        body: JSON.stringify(infoHeadline),
                    }).then((response)=>response.json()
                        ).then((data)=>{
                         
                            if (data==="session_expired"){
                            
      document.getElementById("expired_session").classList.remove('hidden')
      document.getElementsByClassName("intro")[0].classList.add('hidden')
      document.getElementsByClassName("btn_div")[0].classList.add('hidden')

                                
      window.onbeforeunload= ()=>{
        window.setTimeout(()=>{
            window.location='/'
        },0)
        window.onbeforeunload=null
      }
    }
    else{
                            data=Object.entries(data)
                            
                    if (data.length===0){
                                const links=document.getElementsByTagName('a')
                                for (i of links){
                                    i.classList=''}
                            }
                    else{
                                id1=data[0][0]
                                vote1=data[0][1]
                        if(vote1==='Upvote'){
                                document.getElementById(`tu${id1}`).classList.add('purple')
                            }
                        else{
                                document.getElementById(`td${id1}`).classList.add('purple')
                            }
                            }
            }})
                 }
               const vote= document.getElementsByName('vote')
               for( i of vote){
                const id=i.dataset.id
                const page=i.dataset.page
                const value=i.dataset.vote


               i.addEventListener('click',(e)=>{

                e.preventDefault()     
        fetch(`/vote/${id}/${value}`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({'infoHeadline':infoHeadline})
}).then(response=>response.json()).then(
                        data=>{
                            
                            document.getElementById('taskuncomplete').classList.add("hidden")
            
                            if (data==='session expired'){
                                document.getElementById('expired_session').classList.remove('hidden')
                                document.getElementsByClassName("intro")[0].classList.add('hidden')
                                document.getElementsByClassName('btn_div')[0].classList.add('hidden')
                                window.onbeforeunload= ()=>{
                                    window.setTimeout(()=>{
                                        window.location='/'
                                    },0)
                                    window.onbeforeunload=null
                                }
                            }
    else{
    if (infoHeadline.length===1){
    if (value==='upvote'){
        document.getElementById(`tu${id}`).classList.add('purple')
        document.getElementById(`td${id}`).classList.remove('purple')
    }
    else{
        document.getElementById(`td${id}`).classList.add('purple')
        document.getElementById(`tu${id}`).classList.remove('purple')
    }

document.querySelector(`#tu${id} :nth-child(2)`).innerHTML=data['count1']['upvote']
document.querySelector(`#td${id} :nth-child(2)`).innerHTML=data['count1']['downvote']



}
else{
                      
                const index=infoHeadline.indexOf(id) 
                       
                if (value==='upvote'){
                            document.getElementById(`tu${id}`).classList.add('purple')
                            
                            document.getElementById(`td${id}`).classList.remove('purple')
                            
                            if(index==0){
                            document.getElementById(`tu${infoHeadline[1]}`).classList.remove('purple')
                            document.getElementById(`td${infoHeadline[1]}`).classList.remove('purple')}
                            else{
                            document.getElementById(`tu${infoHeadline[0]}`).classList.remove('purple')
                            document.getElementById(`td${infoHeadline[0]}`).classList.remove('purple')}
                            }
                        
                    else{
                        document.getElementById(`td${id}`).classList.add('purple')
                        document.getElementById(`tu${id}`).classList.remove('purple')
                         if(index==0){
                            document.getElementById(`tu${infoHeadline[1]}`).classList.remove('purple')
                            document.getElementById(`td${infoHeadline[1]}`).classList.remove('purple')}
                            else{
                            document.getElementById(`tu${infoHeadline[0]}`).classList.remove('purple')
                            document.getElementById(`td${infoHeadline[0]}`).classList.remove('purple')}
                    }

                    

                    document.querySelector(`#tu${infoHeadline[0]} :nth-child(2)`).innerHTML=data['count1']['upvote']
                    document.querySelector(`#td${infoHeadline[0]} :nth-child(2)`).innerHTML=data['count1']['downvote']
                    document.querySelector(`#tu${infoHeadline[1]} :nth-child(2)`).innerHTML=data['count2']['upvote']
                    document.querySelector(`#td${infoHeadline[1]} :nth-child(2)`).innerHTML=data['count2']['downvote']

                  

                        }}}
                        )

                })
              
                    }


    
               const info= document.getElementById("info")
               if(info){
                   info.addEventListener('click',()=>{
                       fetch(`/validatetask/`,
                       {
                        method:"POST",
                        headers:{'Content-Type':'application/json'},
                        body:JSON.stringify(infoHeadline)
                       }
                       ).then(response=>response.json()).then(
                        data=>{ 
                            
                            if (data==='session_expired'){
    document.getElementById('expired_session').classList.remove('hidden')
    document.getElementsByClassName('btn_div')[0].classList.add('hidden')
    document.getElementsByClassName("intro")[0].classList.add('hidden')
   

    window.onbeforeunload= ()=>{
        window.setTimeout(()=>{
            window.location='/'
        },0)
        window.onbeforeunload=null
      }
    }
    else{

                            if (data==='true'){
                            window.location.href='{%url "info"%}'
                        }
                        else{
                            document.getElementById('taskuncomplete').classList.remove('hidden')
                        }}
              
                    })
    
 })}
                </script>
    </body>  
</html>